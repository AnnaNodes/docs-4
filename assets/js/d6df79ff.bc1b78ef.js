"use strict";(self.webpackChunkdocs_2=self.webpackChunkdocs_2||[]).push([[8754],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=p(n),d=r,h=u["".concat(s,".").concat(d)]||u[d]||m[d]||a;return n?o.createElement(h,l(l({ref:t},c),{},{components:n})):o.createElement(h,l({ref:t},c))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=u;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var p=2;p<a;p++)l[p]=n[p];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},3178:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>a,metadata:()=>i,toc:()=>p});var o=n(7462),r=(n(7294),n(3905));const a={},l="Performance & Profiling",i={unversionedId:"developing/osmosis-core/performance",id:"developing/osmosis-core/performance",title:"Performance & Profiling",description:"Profiling with pprof",source:"@site/docs/developing/osmosis-core/performance.md",sourceDirName:"developing/osmosis-core",slug:"/developing/osmosis-core/performance",permalink:"/docs/developing/osmosis-core/performance",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/developing/osmosis-core/performance.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"osmosisd",permalink:"/docs/developing/osmosis-core/osmosisd"},next:{title:"CosmWasm Smart Contracts",permalink:"/docs/category/cosmwasm-smart-contracts"}},s={},p=[{value:"Profiling with pprof",id:"profiling-with-pprof",level:2},{value:"Memory",id:"memory",level:3},{value:"Causes",id:"causes",level:4},{value:"Interpreting Output",id:"interpreting-output",level:4},{value:"Useful links",id:"useful-links",level:3},{value:"Benchmarking",id:"benchmarking",level:2},{value:"Best practices",id:"best-practices",level:3},{value:"Example",id:"example",level:3},{value:"Useful links:",id:"useful-links-1",level:3}],c={toc:p};function m(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,o.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"performance--profiling"},"Performance & Profiling"),(0,r.kt)("h2",{id:"profiling-with-pprof"},"Profiling with pprof"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Query the pprof cpu endpoint on the node host: ",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"CPU"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"curl -X GET localhost:6060/debug/pprof/profile?seconds=<number> > <filename>")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Heap"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"curl -X GET localhost:6060/debug/pprof/heap?seconds=<number> > <filename>")),(0,r.kt)("li",{parentName:"ul"},"can query from your local machine by substituting localhost with the IP of the node, depending on your network setup. By doing this, can skip step 2."))),(0,r.kt)("li",{parentName:"ol"},"If querying on the node host, SCP the file to yourself: ",(0,r.kt)("inlineCode",{parentName:"li"},"scp <filename> <user>@<host>:<path>"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"E.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"scp <filename> root@143.182.133.71:/home/roman/osmosis/pprof")),(0,r.kt)("li",{parentName:"ul"},"ensure that your ISP or firewall is not blocking the file transfer"))),(0,r.kt)("li",{parentName:"ol"},"Run a web server and open up a browser",(0,r.kt)("inlineCode",{parentName:"li"},"go tool pprof -http=localhost:8080 <filename>"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"graphviz")," must be installed")))),(0,r.kt)("h3",{id:"memory"},"Memory"),(0,r.kt)("h4",{id:"causes"},"Causes"),(0,r.kt)("p",null,"The following cause memory issues in Go\n\u2013 Creating substrings and subslices.\n\u2013 Wrong use of the defer statement.\n\u2013 Unclosed HTTP response bodies (or unclosed resources in general).\n\u2013 Orphaned hanging go routines.\n\u2013 Global variables."),(0,r.kt)("h4",{id:"interpreting-output"},"Interpreting Output"),(0,r.kt)("p",null,"\u2013 ",(0,r.kt)("inlineCode",{parentName:"p"},"inuse_space"),": Means pprof is showing the amount of memory allocated\nand not yet released.\n\u2013 ",(0,r.kt)("inlineCode",{parentName:"p"},"inuse_objects"),": Means pprof is showing the amount of objects allocated\nand not yet released.\n\u2013 ",(0,r.kt)("inlineCode",{parentName:"p"},"alloc_space"),": Means pprof is showing the amount of memory allocated,\nregardless if it was released or not.\n\u2013 ",(0,r.kt)("inlineCode",{parentName:"p"},"alloc_objects"),": Means pprof is showing the amount of objects allocated,\nregardless if they were released or not."),(0,r.kt)("p",null,"\u2013 ",(0,r.kt)("inlineCode",{parentName:"p"},"flat"),": Represents the memory allocated by a function and still held by that\nfunction.\n\u2013 ",(0,r.kt)("inlineCode",{parentName:"p"},"cum"),": Represents the memory allocated by a function or any other function\nthat is called down the stack."),(0,r.kt)("h3",{id:"useful-links"},"Useful links"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://pkg.go.dev/net/http/pprof"},"Pprof Doc")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://graphviz.org/download/"},"Graphviz Download")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://linuxize.com/post/how-to-use-scp-command-to-securely-transfer-files/"},"Using SCP")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.youtube.com/watch?v=xxDZuPEgbBU"},"Advanced Go Profiling Talk (YouTube)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/bradfitz/talk-yapc-asia-2015/blob/master/talk.md"},"Notes from the talk above")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://go101.org/article/memory-leaking.html"},"Memory Leaking Scenarios")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/"},"Great blogpost about profiling heap"))),(0,r.kt)("h2",{id:"benchmarking"},"Benchmarking"),(0,r.kt)("h3",{id:"best-practices"},"Best practices"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Running the benchmarks on an idle machine not running on battery"),(0,r.kt)("li",{parentName:"ul"},"Use ",(0,r.kt)("inlineCode",{parentName:"li"},"-benchmem")," to also get stats on allocated objects and space"),(0,r.kt)("li",{parentName:"ul"},"Use ",(0,r.kt)("inlineCode",{parentName:"li"},"benchstat")," to compare performance across different git branches"),(0,r.kt)("li",{parentName:"ul"},"Adding -run='$^' or -run=- to each go test command to avoid running the tests too")),(0,r.kt)("p",null,"Benchstat sample output for illustration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"name                old time/op    new time/op    delta\nDecode-4               2.20s \xb1 0%     1.54s \xb1 0%   ~     (p=1.000 n=1+1)\n")),(0,r.kt)("p",null,"For benchstat specifically:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Using higher -count values if the benchmark numbers aren't stable",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"if you don't, your sample size would be too small and ",(0,r.kt)("inlineCode",{parentName:"li"},"delta")," might not be reported (like in example above) because it is not significant enough."),(0,r.kt)("li",{parentName:"ul"},"if you do, might take longer since you need multiple runs to get a good sample size"),(0,r.kt)("li",{parentName:"ul"},"people recommend 5 as a good enough sample size")))),(0,r.kt)("p",null,"Adding -run='$^' or -run=- to each go test command to avoid running the tests too"),(0,r.kt)("h3",{id:"example"},"Example"),(0,r.kt)("p",null,"Let's assume that we are working on branch ",(0,r.kt)("inlineCode",{parentName:"p"},"osmosis/string")," and added some performance improvements to ",(0,r.kt)("inlineCode",{parentName:"p"},"tree.String()"),"."),(0,r.kt)("p",null,"As a result, we would like to bench test like in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/osmosis-labs/iavl/blob/141d98dba805ca1960160b1ec98c6f243792e25c/nodedb_test.go#L33-L46"},"the following")," in iavl."),(0,r.kt)("p",null,"To get a nice bench summary we would follow these steps:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Checkout the ",(0,r.kt)("inlineCode",{parentName:"li"},"master")," branch and get the output of the benchmark:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"git checkout master\n\ngo test -benchmem -run=^$ -bench ^BenchmarkTreeString$ -benchmem -count 5 github.com/cosmos/iavl > bench_string_old.txt\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Checkout our ",(0,r.kt)("inlineCode",{parentName:"li"},"osmosis/string")," branch and get the output of the benchmark:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"git checkout master\n\ngo test -benchmem -run=^$ -bench ^BenchmarkTreeString$ -benchmem -count 5 github.com/cosmos/iavl > bench_string_new.txt\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Compare the two outputs with ",(0,r.kt)("inlineCode",{parentName:"li"},"benchstat"),":")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"benchstat bench_string_old.txt bench_string_new.txt\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Evaluate the output and attach to your PR, if needed")),(0,r.kt)("h3",{id:"useful-links-1"},"Useful links:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://pkg.go.dev/golang.org/x/perf/cmd/benchstat"},"Benchstat Doc")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/golang/go/issues/23471"},"Tips for Newcomers"))))}m.isMDXComponent=!0}}]);